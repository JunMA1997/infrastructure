{
  "AWSTemplateFormatVersion":"2010-09-09",
  "Description": "Launch EC2 with requirement url:https://spring2020.csye6225.cloud/assignments/05/#aws-networking-setup",
  "Parameters" : {
    "GroupDescription":{
      "Type":"String",
      "Default":""
    },
    "GroupName":{
      "Type":"String",
      "Default":""  
    },
    "VPCCIDR":{
      "Type":"String",
      "Default":""
    },
    "SubnetCIDR0":{
      "Type":"String",
      "Default":""
    },
    "SubnetCIDR1":{
      "Type":"String",
      "Default":""
    },
    "SubnetCIDR2":{
      "Type":"String",
      "Default":""
    },
    "VPCNAME":{
      "Type":"String",
      "Default":""
    },
    "AWSregion":{
      "Type":"String",
      "Default":"us-east-1"
    }
  },
  "Resources": {
    "EC2InternetGateway":{
      "Type":"AWS::EC2::InternetGateway",
      "DependsOn": "EC2VPC0",
      "Properties":{}
    },
    "EC2VPC0":{
      
      "Type":"AWS::EC2::VPC",
      "Properties":{
        "CidrBlock": {"Ref":"VPCCIDR"},
        "Tags":[{"Key":"Name","Value":{"Ref":"VPCNAME"}}],
        "EnableDnsSupport":"true",
        "EnableDnsHostnames":"true",
        "InstanceTenancy":"default"
      }
    },
    "EC2SUBNET0":{
      "Type":"AWS::EC2::Subnet",       
      "Properties":{
        "AvailabilityZone":{"Fn::Select":["0",{"Fn::GetAZs":{"Ref":"AWSregion"}}]},
        "VpcId": {"Ref" :"EC2VPC0"},
        "MapPublicIpOnLaunch":true, 
        "CidrBlock":{"Ref":"SubnetCIDR0"}
      }
    },
    "EC2SUBNET1":{
      "Type":"AWS::EC2::Subnet",
       
      "Properties":{
        "AvailabilityZone":{"Fn::Select":["0",{"Fn::GetAZs":{"Ref":"AWSregion"}}]},
        "VpcId": {"Ref" :"EC2VPC0"},
        "MapPublicIpOnLaunch":true, 
        "CidrBlock":{"Ref":"SubnetCIDR1"}
      }
    },
    "EC2SUBNET2":{        
      "Type":"AWS::EC2::Subnet",
       
      "Properties":{
        "AvailabilityZone":{"Fn::Select":["0",{"Fn::GetAZs":{"Ref":"AWSregion"}}]},
        "VpcId": {"Ref" :"EC2VPC0"},
        "MapPublicIpOnLaunch":true, 
        "CidrBlock":{"Ref":"SubnetCIDR2"}
      }
    },
    
    "AttachGateway":{
      "Type":"AWS::EC2::VPCGatewayAttachment",
      "DependsOn":["EC2VPC0","EC2InternetGateway"],
      "Properties":{
        "VpcId":{"Ref":"EC2VPC0"},
        "InternetGatewayId":{"Ref":"EC2InternetGateway"}
      }
    },
    "EC2RouteTable":{
      "Type":"AWS::EC2::RouteTable",
      "DependsOn":"EC2VPC0",
      "Properties":{
        "VpcId":{"Ref":"EC2VPC0"},
        "Tags":[{"Key":"Name","Value":"RouteTable"}]
      }
    },
    "RouteTableAssociationWithEC2SUBNET0" : {

      "DependsOn":["EC2SUBNET0" ,"EC2RouteTable"]  ,
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "EC2SUBNET0" },
        "RouteTableId" : { "Ref" : "EC2RouteTable" }
      }
    },
    "RouteTableAssociationWithEC2SUBNET1" : {
      "DependsOn":["EC2SUBNET1" ,"EC2RouteTable"]  ,
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "EC2SUBNET1" },
        "RouteTableId" : { "Ref" : "EC2RouteTable" }
      }
    },
    "RouteTableAssociationWithEC2SUBNET2" : {
      "DependsOn":["EC2SUBNET2" ,"EC2RouteTable"]  ,
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "EC2SUBNET2" },
        "RouteTableId" : { "Ref" : "EC2RouteTable" }
      }
    },
    "EC2Route":{
      "DependsOn":["EC2VPC0" ,"EC2InternetGateway","AttachGateway"]  ,
      "Type": "AWS::EC2::Route",
      "Properties" : {
        "RouteTableId" : { "Ref" : "EC2RouteTable" },
        "GatewayId" : { "Ref" : "EC2InternetGateway" },
        "DestinationCidrBlock" : "0.0.0.0/0"
        
      }
    },
    "AppInstanceSecurityGroup":{
      "Type" : "AWS::EC2::SecurityGroup",
      "DependsOn":"EC2VPC0",
      "Properties" : {
          "GroupDescription" : "application security group for 22 80 443 and 3000(app)",
          "GroupName" : "application",
          "SecurityGroupIngress" : [
            {
              "IpProtocol":"TCP",
              "CidrIp":"0.0.0.0/0",
              "FromPort" : "22",
              "ToPort" : "22"
            },
            {
              "IpProtocol":"TCP",
              "CidrIp":"0.0.0.0/0",
              "FromPort" : "80",
              "ToPort" : "80"
            },
            {
              "IpProtocol":"TCP",
              "CidrIp":"0.0.0.0/0",
              "FromPort" : "443",
              "ToPort" : "443"
            },
            {
              "IpProtocol":"TCP",
              "CidrIp":"0.0.0.0/0",
              "FromPort" : "3000",
              "ToPort" : "3000"
            }
          ],
          "VpcId" : {"Ref":"EC2VPC0"}
        }
    },
    "DBSInstanceSecurityGroup":{
      "Type" : "AWS::EC2::SecurityGroup",
      "DependsOn":"AppInstanceSecurityGroup",
      "Properties" : {
          "GroupDescription" : "database security group for 3306",
          "GroupName" : "database",
          "SecurityGroupIngress" : [
            {
              "IpProtocol":"TCP",
              "SourceSecurityGroupId":{"Ref":"AppInstanceSecurityGroup"},
              "FromPort" : "3306",
              "ToPort" : "3306"
            }
          ],
          "VpcId" : {"Ref":"EC2VPC0"}
        }
    }
  },
  "Outputs": {    
  }
}